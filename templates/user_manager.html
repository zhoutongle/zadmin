<!DOCTYPE html>
<html>

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">


    <title> - Bootstrap Table</title>
    <meta name="keywords" content="">
    <meta name="description" content="">
    
</head>

<body class="gray-bg">
    <div class="wrapper wrapper-content animated fadeInRight">
        <!-- Panel Other -->
        <div class="ibox float-e-margins">
            <div class="ibox-title">
                <h5>用户列表</h5>
            </div>
            <div class="ibox-content">
                <div class="row row-lg">
                    <div class="col-sm-2">
                        <div class="ibox float-e-margins">
                            <div class="ibox-title">
                                <h5>单位名称</h5>
                                <div class="ibox-tools">
                                    <a class="collapse-link">
                                        <i class="fa fa-plus" title="添加" data-toggle="modal" data-target="#add_department"></i>
                                    </a>
                                    <a class="dropdown-toggle">
                                        <i class="fa fa-wrench" title="修改"></i>
                                    </a>
                                    <a class="close-link">
                                        <i class="fa fa-trash" title="删除" onclick="del_department();"></i>
                                    </a>
                                </div>
                            </div>
                            <div class="ibox-content">

                                <div id="jstree1" style="min-width:101%;overflow-x:auto">
                                    <ul>
                                        <li class="jstree-open">所属部门
                                            <ul>
                                                <li data-jstree='{"type":"html"}'>研发一部</li>
                                                <li data-jstree='{"type":"html"}'>研发二部</li>
                                                <li data-jstree='{"type":"html"}'>研发三部</li>
                                                <li data-jstree='{"type":"html"}'>测试一部</li>
                                                <li data-jstree='{"type":"html"}'>测试二部</li>
                                                <li data-jstree='{"type":"html"}'>测试三部</li>
                                                <li data-jstree='{"type":"html"}'>硬件部</li>
                                                <li data-jstree='{"type":"html"}'>生产部</li>
                                            </ul>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                    </div>
                    <div class="col-sm-10">
                        <!-- Example Events -->
                        <div class="example-wrap">
                            <div class="example">
                                <div class="btn-group hidden-xs" id="exampleTableEventsToolbar" role="group">
                                    <button type="button" class="btn btn-outline btn-default" data-toggle="modal" data-target="#add_user">
                                        <i class="glyphicon glyphicon-plus" aria-hidden="true"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline btn-default">
                                        <i class="glyphicon glyphicon-heart" aria-hidden="true"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline btn-default" onclick="del_user();">
                                        <i class="glyphicon glyphicon-trash" aria-hidden="true"></i>
                                    </button>
                                </div>
                                <table id="user_manager_table" data-height="400" data-mobile-responsive="true">
                                    <thead>
                                        <tr>
                                            <th data-field="state" data-checkbox="true"></th>
                                            <th data-field="id">ID</th>
                                            <th data-field="name">名称</th>
                                            <th data-field="mail">邮箱</th>
                                        </tr>
                                    </thead>
                                </table>
                            </div>
                        </div>
                        <!-- End Example Events -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- 添加用户 -->
    <div class="modal inmodal" id="add_user" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="static">
        <div class="modal-dialog">
            <div class="modal-content animated bounceInRight">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" onclick="form_reset('add_user_form')"><span aria-hidden="true">&times;</span><span class="sr-only">关闭</span></button>
                    <h4 class="modal-title">添加用户</h4>
                    <small class="font-bold">123</small>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <form id="add_user_form" class="wizard-big">
                            <h1>账户</h1>
                            <fieldset>
                                <h2>账户信息</h2>
                                <div class="row">
                                    <div class="col-sm-8">
                                        <div class="form-group">
                                            <label>用户名 </label><span style="color:red">*</span>
                                            <input id="user_name" name="user_name" type="text" class="form-control required">
                                        </div>
                                        <div class="form-group">
                                            <label>密码 </label><span style="color:red">*</span>
                                            <input id="new_password" name="new_password" type="password" class="form-control required">
                                        </div>
                                        <div class="form-group">
                                            <label>确认密码 </label><span style="color:red">*</span>
                                            <input id="confirm_password" name="confirm_password" type="password" class="form-control required">
                                        </div>
                                    </div>
                                </div>

                            </fieldset>
                            <h1>个人资料</h1>
                            <fieldset>
                                <h2>个人资料信息</h2>
                                <div class="row">
                                    <div class="col-sm-6">
                                        <div class="form-group">
                                            <label>真实姓名 </label><span style="color:red">*</span>
                                            <input id="real_name" name="read_name" type="text" class="form-control required">
                                        </div>
                                        <div class="form-group">
                                            <label>性别 </label><span style="color:red">*</span><br />
                                            <div class="radio radio-info radio-inline">
                                                <input type="radio" id="inlineRadio1" value="option1" name="radioInline" checked="">
                                                <label for="inlineRadio1">男</label>
                                            </div>
                                            <div class="radio radio-inline">
                                                <input type="radio" id="inlineRadio2" value="option2" name="radioInline">
                                                <label for="inlineRadio2">女</label>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="font-noraml">年龄</label><span style="color:red">*</span>
                                            <div class="input-group">
                                                <select data-placeholder="选择省份..." class="chosen-select" tabindex="2">
                                                    <option value="">请选择省份</option>
                                                    <option value="110000" hassubinfo="true">北京</option>
                                                    <option value="120000" hassubinfo="true">天津</option>
                                                    <option value="130000" hassubinfo="true">河北省</option>
                                                    <option value="140000" hassubinfo="true">山西省</option>
                                                    <option value="150000" hassubinfo="true">内蒙古自治区</option>
                                                    <option value="210000" hassubinfo="true">辽宁省</option>
                                                    <option value="220000" hassubinfo="true">吉林省</option>
                                                    <option value="230000" hassubinfo="true">黑龙江省</option>
                                                    <option value="310000" hassubinfo="true">上海</option>
                                                    <option value="320000" hassubinfo="true">江苏省</option>
                                                    <option value="330000" hassubinfo="true">浙江省</option>
                                                    <option value="340000" hassubinfo="true">安徽省</option>
                                                    <option value="350000" hassubinfo="true">福建省</option>
                                                    <option value="360000" hassubinfo="true">江西省</option>
                                                    <option value="370000" hassubinfo="true">山东省</option>
                                                    <option value="410000" hassubinfo="true">河南省</option>
                                                    <option value="420000" hassubinfo="true">湖北省</option>
                                                    <option value="430000" hassubinfo="true">湖南省</option>
                                                    <option value="440000" hassubinfo="true">广东省</option>
                                                    <option value="450000" hassubinfo="true">广西壮族自治区</option>
                                                    <option value="460000" hassubinfo="true">海南省</option>
                                                    <option value="500000" hassubinfo="true">重庆</option>
                                                    <option value="510000" hassubinfo="true">四川省</option>
                                                    <option value="520000" hassubinfo="true">贵州省</option>
                                                    <option value="530000" hassubinfo="true">云南省</option>
                                                    <option value="540000" hassubinfo="true">西藏自治区</option>
                                                    <option value="610000" hassubinfo="true">陕西省</option>
                                                    <option value="620000" hassubinfo="true">甘肃省</option>
                                                    <option value="630000" hassubinfo="true">青海省</option>
                                                    <option value="640000" hassubinfo="true">宁夏回族自治区</option>
                                                    <option value="650000" hassubinfo="true">新疆维吾尔自治区</option>
                                                    <option value="710000" hassubinfo="true">台湾省</option>
                                                    <option value="810000" hassubinfo="true">香港特别行政区</option>
                                                    <option value="820000" hassubinfo="true">澳门特别行政区</option>
                                                    <option value="990000" hassubinfo="true">海外</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-sm-6">
                                        <div class="form-group">
                                            <label>Email </label><span style="color:red">*</span>
                                            <input id="user_mail" name="user_mail" type="text" class="form-control required email">
                                        </div>
                                        <div class="form-group">
                                            <label>地址 </label><span style="color:red">*</span>
                                            <input id="address" name="address" type="text" class="form-control">
                                        </div>
                                    </div>
                                </div>
                            </fieldset>

                            <h1>警告</h1>
                            <fieldset>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="image-crop">
                                            <img src="/static/img/img/a3.jpg">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <h4>图片预览：</h4>
                                        <div class="img-preview img-preview-sm"></div>
                                        <h4>说明：</h4>
                                        <p>
                                            你可以选择新图片上传，然后下载裁剪后的图片
                                        </p>
                                        <div class="btn-group">
                                            <label title="上传图片" for="inputImage" class="btn btn-primary">
                                                <input type="file" accept="image/*" name="file" id="inputImage" class="hide"> 上传新图片
                                            </label>
                                            <label title="下载图片" id="download" class="btn btn-primary">下载</label>
                                        </div>
                                        <div class="btn-group">
                                            <button class="btn btn-white" id="zoomIn" type="button">放大</button>
                                            <button class="btn btn-white" id="zoomOut" type="button">缩小</button>
                                            <button class="btn btn-white" id="rotateLeft" type="button">左旋转</button>
                                            <button class="btn btn-white" id="rotateRight" type="button">右旋转</button>
                                            <button class="btn btn-warning" id="setDrag" type="button">裁剪</button>
                                        </div>
                                    </div>
                                </div>
                            </fieldset>

                            <h1>完成</h1>
                            <fieldset>
                                <h2>条款</h2>
                                <input id="acceptTerms" name="acceptTerms" type="checkbox" class="required">
                                <label for="acceptTerms">我同意注册条款</label>
                            </fieldset>
                        </form>
                    </div>
                    <!--form class="form-horizontal m-t" id="add_user_form">
                        <div class="form-group">
                            <label class="col-sm-3 control-label">用户名：</label>
                            <div class="col-sm-8">
                                <input id="user_name" name="user_name" class="form-control" type="text">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-3 control-label">邮箱：</label>
                            <div class="col-sm-8">
                                <input id="user_mail" name="user_mail" class="form-control" type="text">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-3 control-label">新密码：</label>
                            <div class="col-sm-8">
                                <input id="new_password" name="new_password" class="form-control" type="password">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-3 control-label">确认密码：</label>
                            <div class="col-sm-8">
                                <input id="confirm_password" name="confirm_password" class="form-control" type="password">
                                <span class="help-block m-b-none"><i class="fa fa-info-circle"></i> 请再次输入您的密码</span>
                            </div>
                        </div>
                    </form-->
                </div>
                <!--div class="modal-footer">
                    <button type="button" class="btn btn-white" data-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" onclick="add_user();">保存</button>
                </div-->
            </div>
        </div>
    </div>
    <!-- 添加部门 -->
    <div class="modal inmodal" id="add_department" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="static">
        <div class="modal-dialog">
            <div class="modal-content animated bounceInRight">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">关闭</span></button>
                    <!--i class="fa fa-laptop modal-icon"></i-->
                    <h4 class="modal-title">添加部门</h4>
                    <small class="font-bold">这里可以显示副标题。
                </div>
                <div class="modal-body">
                    <form class="form-horizontal m-t" id="add_user_form">
                        <div class="form-group">
                            <label class="col-sm-3 control-label">名称：</label>
                            <div class="col-sm-8">
                                <input id="department_name" name="department_name" class="form-control" type="text">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-3 control-label">信息：</label>
                            <div class="col-sm-8">
                                <input id="user_mail" name="user_mail" class="form-control" type="text">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-white" data-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" onclick="add_department();">保存</button>
                </>
            </div>
        </div>
    </div>
</body>

</html>

<style>
    .jstree-open > .jstree-anchor > .fa-folder:before {
        content: "\f07c";
    }

    .jstree-default .jstree-icon.none {
        width: 0;
    }
</style>

<script>

    var $image = $(".image-crop > img")
    $($image).cropper({
        aspectRatio: 1.618,
        preview: ".img-preview",
        done: function (data) {
            // 输出结果
        }
    });

    var $inputImage = $("#inputImage");
    if (window.FileReader) {
        $inputImage.change(function () {
            var fileReader = new FileReader(),
                files = this.files,
                file;

            if (!files.length) {
                return;
            }

            file = files[0];

            if (/^image\/\w+$/.test(file.type)) {
                fileReader.readAsDataURL(file);
                fileReader.onload = function () {
                    $inputImage.val("");
                    $image.cropper("reset", true).cropper("replace", this.result);
                };
            } else {
                showMessage("请选择图片文件");
            }
        });
    } else {
        $inputImage.addClass("hide");
    }

    $("#download").click(function () {
        window.open($image.cropper("getDataURL"));
    });

    $("#zoomIn").click(function () {
        $image.cropper("zoom", 0.1);
    });

    $("#zoomOut").click(function () {
        $image.cropper("zoom", -0.1);
    });

    $("#rotateLeft").click(function () {
        $image.cropper("rotate", 45);
    });

    $("#rotateRight").click(function () {
        $image.cropper("rotate", -45);
    });

    $("#setDrag").click(function () {
        $image.cropper("setDragMode", "crop");
    });

    //年龄
    $("#ionrange").ionRangeSlider({
        values: [
            "一月", "二月", "三月",
            "四月", "五月", "六月",
            "七月", "八月", "九月",
            "十月", "十一月", "十二月"
        ],
        type: 'single',
        hasGrid: true
    });

    (function(document, window, $) {
        (function() {
            $('#user_manager_table').bootstrapTable({
                url: '{{url_for("user_manager")}}',
                method: 'POST',
                height: '',
                search: true,
                pagination: true,
                showRefresh: true,
                showToggle: true,
                showColumns: true,
                striped: true,               // 表格条纹
                pagination: true,            // 在表格底部显示分页组件，默认false
                pageList: [10, 25, 50, 100], // 设置页面可以显示的数据条数
                iconSize: 'outline',
                toolbar: '#exampleTableEventsToolbar',
                icons: {
                    refresh: 'glyphicon-repeat',
                    toggle: 'glyphicon-list-alt',
                    columns: 'glyphicon-list'
                }
            });
        })();
    })(document, window, jQuery);
    
    $(document).ready(function () {
        $("#add_user_form").steps({
            bodyTag: "fieldset",
            onStepChanging: function (event, currentIndex, newIndex) {
                // Always allow going backward even if the current step contains invalid fields!
                if (currentIndex > newIndex) {
                    return true;
                }
                // Forbid suppressing "Warning" step if the user is to young
                if (newIndex === 3 && Number($("#age").val()) < 18) {
                    return false;
                }
                var add_user_form = $(this);
                // Clean up if user went backward before
                if (currentIndex < newIndex) {
                    // To remove error styles
                    $(".body:eq(" + newIndex + ") label.error", add_user_form).remove();
                    $(".body:eq(" + newIndex + ") .error", add_user_form).removeClass("error");
                }
                // Disable validation on fields that are disabled or hidden.
                add_user_form.validate().settings.ignore = ":disabled,:hidden";
                // Start validation; Prevent going forward if false
                return add_user_form.valid();
            },
            onStepChanged: function (event, currentIndex, priorIndex) {
                // Suppress (skip) "Warning" step if the user is old enough.
                if (currentIndex === 2 && Number($("#age").val()) >= 18) {
                    $(this).steps("next");
                }
                // Suppress (skip) "Warning" step if the user is old enough and wants to the previous step.
                if (currentIndex === 2 && priorIndex === 3) {
                    $(this).steps("previous");
                }
            },
            onFinishing: function (event, currentIndex) {
                var add_user_form = $(this);
                // Disable validation on fields that are disabled.
                // At this point it's recommended to do an overall check (mean ignoring only disabled fields)
                add_user_form.validate().settings.ignore = ":disabled";
                // Start validation; Prevent form submission if false
                return add_user_form.valid();
            },
            onFinished: function (event, currentIndex) {
                add_user();
            },
            onCanceled: function (event, currentIndex, newIndex, priorIndex){
                form_reset('add_user_form');
                $(this).steps("previous");
                $(this).steps("previous");
                $(this).steps("previous");
                $('#add_user').modal('hide');
            }
        }).validate({
            errorPlacement: function (error, element) {
                element.before(error);
            },
            rules: {
                confirm_password: {
                    equalTo: "#new_password"
                }
            }
        });
    });

    $(document).ready(function () {
        $('#jstree1').jstree({
            'core': {
                'check_callback': true
            },
            'plugins': ['types', 'dnd'],
            'types': {
                'default': {
                    'icon': 'fa fa-folder'
                },
                'html': {
                    'icon': 'fa fa-file-code-o'
                },
                'svg': {
                    'icon': 'fa fa-file-picture-o'
                },
                'css': {
                    'icon': 'fa fa-file-code-o'
                },
                'img': {
                    'icon': 'fa fa-file-image-o'
                },
                'js': {
                    'icon': 'fa fa-file-text-o'
                }

            }
        });
    });
        
    //添加用户的表单验证
    $().ready(function () {

        // validate signup form on keyup and submit
        var icon = "<i class='fa fa-times-circle'></i> ";
        $("#add_user_form").validate({
            rules: {
                user_name: {
                    required: true,
                    rangelength: [2, 20]
                },
                user_mail: {
                    required: true,
                    email: true
                },
                new_password: {
                    required: true,
                    rangelength: [6, 12]
                },
                confirm_password: {
                    required: true,
                    rangelength: [6, 12],
                    equalTo: "#new_password"
                }
            },
            messages: {
                user_name: {
                    required: icon + "用户名不能为空！",
                    rangelength: icon + "密码长度应为2-20个字符！"
                },
                user_mail: {
                    required: icon + "请输入您的邮箱地址！",
                    email: icon + "邮箱格式不正确！"
                },
                new_password: {
                    required: icon + "请输入您的新密码",
                    rangelength: icon + "密码长度应为6-12个字符！"
                },
                confirm_password: {
                    required: icon + "请再次输入密码",
                    rangelength: icon + "密码长度应为6-12个字符！",
                    equalTo: icon + "两次输入的密码不一致"
                }
            }
        });
    });
    
    //创建用户
    function add_user(){
        <!-- if(!$("#add_user_form").valid()){ -->
            <!-- return false; -->
        <!-- } -->
        var data = $("#form").serialize();
        $.ajax({
            type: 'POST',
            url: '{{url_for("add_user")}}',
            data: data,
            dataType: 'text',
            success:function(text){
                if(isNaN(text)){
                    swal("操作失败", text, "error");
                }else{
                    if(parseInt(text) == 0){
                        $(".close").click();
                        swal("操作成功", "创建用户成功！", "success");
                        refresh_table('user_manager_table');
                    }else{
                        swal("操作失败", "创建用户失败！", "error");
                    }
                }
            }
        });
    }
    
    //删除用户
    function del_user(){
        var user_obj = $("#user_manager_table").bootstrapTable('getSelections');
        if(user_obj.length <= 0){
            swal("操作失败", "请选择要删除用户！", "error");
            return false;
        }
   
        swal({
            title: "您确定要删除选择的用户吗？",
            text: "删除后将无法恢复，请谨慎操作！",
            type: "warning",
            showCancelButton: true,
            confirmButtonColor: "#DD6B55",
            confirmButtonText: "是的，我要删除！",
            cancelButtonText: "让我再考虑一下…",
            closeOnConfirm: false,
            closeOnCancel: false
        },
        function (isConfirm) {
            if (isConfirm) {
                var user_list = JSON.stringify( user_obj );
                $.ajax({
                    type: 'POST',
                    url: '{{url_for("del_user")}}',
                    data: {'user_list' : user_list},
                    dataType: 'json',
                    traditional:true,//这使json格式的字符不会被转码
                    success:function(text){
                        if(isNaN(text)){
                            swal("操作失败", "删除用户失败！", "error");
                        }else{
                            if(parseInt(text) == 0){
                                swal("删除成功！", "您已经永久删除了选择的用户。", "success");
                                refresh_table('user_manager_table');
                            }else if(parseInt(text) == 1){
                                swal("操作失败", "不能删除管理员！！", "error");
                            }else if(parseInt(text) == 2){
                                swal("操作失败", "不能删除当前登录的用户！", "error");
                            }else{
                                swal("操作失败", "删除用户失败！", "error");
                            }
                        }
                    }
                });
            }else{
                swal("已取消", "您取消了删除操作！", "error");
            }
        });
    }
    
    function del_department(){
        var ref = $('#jstree1').jstree(true);
        var sel = ref.get_selected();
        if(typeof(sel[0]) == 'undefined'){
            swal("操作失败", "请选择要操作的部门！", "error");
            return false;
        }
        var info = $("#"+sel[0]).text().split('\n')[0];
        if(info == '所属部门'){
            swal("操作失败", "请选择要操作的部门！", "error");
            return false;
        }
        swal({
            title: "您确定要删除选择的部门("+ info +")吗？",
            text: "删除后将无法恢复，请谨慎操作！",
            type: "warning",
            showCancelButton: true,
            confirmButtonColor: "#DD6B55",
            confirmButtonText: "是的，我要删除！",
            cancelButtonText: "让我再考虑一下…",
            closeOnConfirm: false,
            closeOnCancel: false
        },
        function (isConfirm) {
            if (isConfirm) {

                return false;
                var user_list = JSON.stringify( user_obj );
                $.ajax({
                    type: 'POST',
                    url: '{{url_for("del_user")}}',
                    data: {'user_list' : user_list},
                    dataType: 'json',
                    traditional:true,//这使json格式的字符不会被转码
                    success:function(text){
                        if(isNaN(text)){
                            swal("操作失败", "删除部门失败！", "error");
                        }else{
                            if(parseInt(text) == 0){
                                swal("删除成功！", "您已经永久删除了选择的部门。", "success");
                                modify_right_content('/user_manager');
                            }else{
                                swal("操作失败", "删除部门失败！", "error");
                            }
                        }
                    }
                });
            }else{
                swal("已取消", "您取消了删除操作！", "error");
            }
        });
    }
    function add_department(){
        
    }
</script>